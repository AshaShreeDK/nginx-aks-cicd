trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

variables:
  RG: "AksRG"
  AKS: "Asha-Aks-Cluster"
  MANIFESTS: "k8s"

steps:
- task: AzureCLI@2
  displayName: 'AKS login, deploy & show public URL'
  inputs:
    azureSubscription: 'azure-sub-connection'   # your service connection name
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      set -euo pipefail

      echo "ğŸ”¹ Installing AKS CLI tools"
      az aks install-cli

      echo "ğŸ”¹ Getting AKS credentials"
      az aks get-credentials -g "$RG" -n "$AKS" --overwrite-existing
      kubelogin convert-kubeconfig -l azurecli

      echo "ğŸ”¹ Applying Kubernetes manifests"
      kubectl apply -f "$MANIFESTS/namespace.yaml"
      kubectl apply -f "$MANIFESTS/deployment.yaml"
      kubectl apply -f "$MANIFESTS/service.yaml"

      echo "ğŸ”¹ Waiting for rollout"
      kubectl -n nginx-demo rollout status deploy/nginx --timeout=180s

      echo "ğŸ”¹ Getting service details"
      kubectl -n nginx-demo get svc nginx -o wide

      echo "ğŸ”¹ Fetching public LoadBalancer IP"
      IP=$(kubectl -n nginx-demo get svc nginx -o jsonpath="{.status.loadBalancer.ingress[0].ip}" || true)
      if [ -n "${IP:-}" ]; then
        echo "âœ… Public URL: http://$IP/"
      else
        echo "âš ï¸ No external IP assigned yet"
      fi
